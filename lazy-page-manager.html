<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../yaml-parser/yaml-parser.html"/>
<link rel="import" href="../iron-ajax/iron-ajax.html"/>
<link rel="import" href="../iron-pages/iron-pages.html"/>
<!-- <link rel="import" href="demo/apps/x-home.html"/> -->
<link rel="import" href="../excess-router/excess-router.html"/>
<link rel="import" href="../iron-localstorage/iron-localstorage.html"/>
<link rel="import" href="../iron-location/iron-location.html"/>
<link rel="import" href="lazy-page-behavior.html"/>
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html"/>
<link rel="import" href="../paper-button/paper-button.html"/>
<link rel="import" href="../paper-dialog/paper-dialog.html"/>
<link rel="import" href="../iron-selector/iron-selector.html"/>
<link rel="import" href="../neon-animation/neon-animations.html"/>
<link rel="import" href="../neon-animation/neon-animated-pages.html"/>
<link rel="import" href="../neon-animation/neon-animatable-behavior.html"/>


<!--
`lazy-page-manager`

基於yaml的頁面管理套件

@demo demo/index.html 


-->

<dom-module id="lazy-page-manager">
	<style include="iron-flex">
		#container{
			width:100%;
			height:100%;
			
		}
		#page{
			overflow-y:auto;
			position: relative;
		}
		:host lazy-pages{
			position: absolute;
			top:0;
			left:0;
			right:0;
			bottom:0;
		}
	</style>
  <template>
  	
  	<template is="dom-if" if="[[__isJSON(mode)]]">
  		<iron-ajax
	    auto
	    url="[[file]]"
	    handle-as="json"
	    last-response="{{docs}}"
	    debounce-duration="300"></iron-ajax>
  	</template>
  	<template is="dom-if" if="[[!__isJSON(mode)]]">
  		<iron-ajax
	    auto
	    url="[[file]]"
	    handle-as="text"
	    last-response="{{yamlStr}}"
	    debounce-duration="300"></iron-ajax>
	    
	    <yaml-parser yaml="[[yamlStr]]" json="{{docs}}"></yaml-parser>
  	</template>
    
    <excess-router-config
	  page-style="hash"
	  hash-prefix="#!"
	></excess-router-config>
	<template is="dom-if" if="[[inited]]">
		<excess-route route="/(.*)" redirect-to="[[docs.defaultPath]]" activation-modifiers="x"></excess-route>
	</template>
    
    <template is="dom-if" if="[[start]]">
    	<div id="container" class=" layout vertical">
		    <div id="page" class="flex">
			    <lazy-pages __inited="{{inited}}" pages="[[docs.sitemap]]" elements-dir="[[docs.elementsDir]]" start></lazy-pages>
		    </div>
		    <template is="dom-if" if="[[__isDev(inited,docs.build)]]">
		    	<lazy-page-dev-tool></lazy-page-dev-tool>
		    </template>
	    </div>
    </template>
  </template>

  <script>
    Polymer({
      is: 'lazy-page-manager',
	  bahaviors:[
		  lazyPageBehavior
	  ],
      properties: {
	    inited:{
		    type:Boolean,
		    value:false,
		    notify:true
	    },
        mode: {
          type: String,
          value:"yaml",
          enum:[
	          "yaml",
	          "json"
          ]
        },
        file:{
	        type: String,
	        value:"docs.yaml"
        },
        docs:{
	        type:Object,
	        notify:true,
	        observer:"__global_docs"
        },
        start:{
	        type:Boolean,
	        value:true
        }
      },
      ready:function(){
	     
      },
	  __global_docs:function(docs){
// 		  console.log(docs);
		  __lazyPageDocs = docs;
	  },
	  __isDev:function(init,build){
		  return init&&build=="dev";
	  },
	  __isJSON:function(mode){
		  return (mode=="json");
	  }
    });
  </script>
</dom-module>


<!--
`lazy-pages`
-->

<dom-module id="lazy-pages">
	<style>
		:host{
			display:block;
			height:100%;
			width:100%;
		}
		:host #page_container{
			position: absolute;
			top:0;
			left:0;
			right:0;
			bottom:0;
		}
		iron-overlay-backdrop{
			z-index:100;
		}
		#dialog_container>*{
			z-index:102;
		}
	</style>
	<template>
		<iron-location hash="{{hash}}" url-space-regex="!(#\!)" ></iron-location>
		<template id="tmp" is="dom-repeat" items="[[pages]]">
			<template is="dom-if" if="[[__isStart(__inited,start)]]" restamp>
				<excess-route 
					route$="[[baseUrl]][[item.pattern]][[__suffix(item.pages)]]" 
					on-excess-route-will-activate="__activeChanged" 
					on-excess-route-will-deactivate="__deactiveChanged">
				</excess-route>
			</template>
		</template>
		<neon-animated-pages
			id="page_container" 
			selected$="[[__pageSelected]]" 
			attr-for-selected="data-page"
			selected-attribute="active">
		</neon-animated-pages>
<!--
		<iron-pages>
		</iron-pages>
-->
		
		<iron-overlay-backdrop id="backdrop"></iron-overlay-backdrop>
		<iron-selector 
			id="dialog_container"
			selected$="[[__pageSelected]]" 
			attr-for-selected="data-page"
			selected-attribute="opened">
		</iron-selector>
		
	</template>
	<script>
		Polymer({
			is:"lazy-pages",
			properties:{
				elementsDir:{
					type:String,
					value:"/"
				},
				pages:{
					type: Object,
					observer: "__pagesChanged"
				},
				baseUrl:{
					type: String,
					value: ""
				},
				__pageSelected:{
					type:String,
					value:"",
					observer:"__pageSelectedChanged"
				},
				__inited:{
					type:Boolean,
					value:false,
					notify:true
				},
				start:{
					type:Boolean,
					value:false
				}
			},
			__suffix:function(pages){
				if(pages==undefined){
					return "";
				}
				if(pages.length>0){
					return "(.*)";
				};
				return "";
			},
			__pageSelectedChanged:function(e){
// 				console.log(e);
			},
			__pagesChanged:function(pages){
				this.__inited=false;
				new Promise(function(resolve,reject){
					this.$.page_container.innerHTML = "";
					this.$.dialog_container.innerHTML="";
					//將pages放置到對應的位置上
					pages.forEach(function(page){
						var page_id = this.baseUrl+page.pattern;
						__lazyPageModule[page_id]=document.createElement(page.ele);
						var ele = __lazyPageModule[page_id]
						ele.setAttribute("data-page",page_id);
						if(page.fragments!=undefined){
							Object.keys(page.fragments).forEach(function(ekey){
								var f_ele = document.createElement(page.fragments[ekey]);
								Polymer.dom(ele).appendChild(f_ele);
							});
						}
						
						if(page.dialog){
							Polymer.dom(this.$.dialog_container).appendChild(ele);
						}else{
							Polymer.dom(this.$.page_container).appendChild(ele);
						}
						
					}.bind(this));
					resolve();
				}.bind(this)).then(function(){
					this.__inited=true;
				}.bind(this)).then(function(){
					pages.forEach(function(page){
						var page_id = this.baseUrl+page.pattern;
						var ele = Polymer.dom(this.root).querySelector("[data-page='"+page_id+"']");
						if(page.pages!=undefined){
							var __lazyPages = document.createElement("lazy-pages");
							__lazyPages.set("elementsDir",this.elementsDir);
							__lazyPages.set("baseUrl",[this.baseUrl,page.pattern].join(""));
							__lazyPages.set("pages",page.pages);
							Polymer.dom(ele).appendChild(__lazyPages);
						}
					}.bind(this));
				}.bind(this)).catch(function(err){
					console.log(err);
				})
				
				
			},
			__deactiveChanged:function(e){
				//判斷所有的路由是不是通通失效了
				//如果通通失效了，就確認上一次執行的module是否已經結束狀態
				var model = this.$.tmp.modelForElement(e.target);
				var pattern = this.baseUrl+model.item.pattern;
				this.async(function(){
					var routes = Polymer.dom(this.root).querySelectorAll("excess-route[active]");
					if(routes.length==0){
						var old_page_id = this.__pageSelected;
						this.__confirmPage(old_page_id).then(function(){
							if(model.item.dialog){
								this.$.backdrop.close();
							}
							this.set("__pageSelected",null);
						}.bind(this)).catch(function(obj){
							console.log(obj);
						}.bind(this));
					}
				},1);
			},
			__activeChanged:function(e){
				//如果有匹配的路由，則呼叫
				
				var that = this;
				var model = this.$.tmp.modelForElement(e.target);
				var page_id = this.baseUrl+model.item.pattern;				
				var module = Polymer.dom(this.root).querySelector("[data-page='"+page_id+"']");
				var router = e.target;				
				var old_page_id = this.__pageSelected;
				var old_module = Polymer.dom(this.root).querySelector("[data-page='"+old_page_id+"']");
				
				
				new Promise(function(resolve,reject){
					//判斷Polymer模組是不是已經初始化了
					Polymer.isInstance(module)?resolve():reject();
				}).catch(function(){
					//去試著importHref進來
					var importHref=this.elementsDir+"/"+module.tagName.toLowerCase()+".html";
					return new Promise(function(resolve,reject){
						Polymer.Base.importHref(importHref,function(){
							resolve();
						}.bind(this),function(){
							reject();
						});
					})
				}.bind(this)).then(function(){
					//如果模組已經初始化或是將檔案import成功後，將裡面的lazyPages啟動
					return new Promise(function(resolve,reject){
						that.async(function(){
							var __lazyPage = Polymer.dom(module).querySelector("lazy-pages");
							var routeParams = router.routeParams;
							module.set("params",routeParams||{});
							if(__lazyPage!=null){
								__lazyPage.set("start",true);
							}
							resolve();
						},50);
					})
				}.bind(this)).then(function(){
					//確認之前的模組是否已經結束？
					
					if(page_id!=old_page_id){
						return new Promise(function(resolve,reject){
							this.__confirmPage(old_page_id).then(function(){
								//上一個模組已確認結束
								resolve();
							}).catch(function(obj){
								//發生異常之類的狀態，先保留起來
								if(obj.continue){
									resolve();
								}else{
									reject("上一個模組拒絕離開頁面");
								}
								
							});
						}.bind(this));
					}
				}.bind(this)).then(function(){
					if(model.item.dialog){
						that.$.backdrop.open();
					}else{
						that.$.backdrop.close();
					}
					
					that.set("__pageSelected",page_id);
					
				}).catch(function(err){
					console.error(err);
				});
				
				
			},
			__isStart:function(a,b){
				return a&&b;
			},
			__confirmPage:function(page_id){
				var module = Polymer.dom(this.root).querySelector("[data-page='"+page_id+"']");
				return new Promise(function(resolve,reject){
					if(module!=null){
						module.__confirm().then(function(){
							resolve()
						}).catch(function(){
							history.forward();
							reject({
								continue:false,
								msg:"拒絕離開"
							})
						});
					}else{
						reject({
							continue:true,
							msg:"找不到模組"
						});
					}
					
				});
			}
		})
	</script>
</dom-module>

<!--
`lazy-page-dev-tool`
用來協助開發所使用，主要用處是協助展示每一頁的案例。
-->
<dom-module id="lazy-page-dev-tool">
	<style include="iron-flex">
		:host{
			display:block;
			background:#FFECB3;
			color:#795548;
			padding:12px;
		}
		.head{
			font-size:18px;
			font-weight: bold;
		}
		paper-button{
			background:#fff;
		}
	</style>
	<template>
		<iron-location hash="{{hash}}" url-space-regex="!(#\!)"></iron-location>
		<div class="layout horizontal">
			<div class="flex">
				<div class="head">Remarks.</div>
				<ul>
					<template is="dom-repeat" items="[[remarks]]">
						<li>[[item]]</li>
					</template>
				</ul>
			</div>
			<div class="flex">
				<div class="head">Cases.</div>
				<template is="dom-repeat" items="[[cases]]">
					<paper-button on-click="callTest" raised>[[item.title]]</paper-button>
				</template>
			</div>
		</div>
		
	</template>
	<script>
		Polymer({
			is:"lazy-page-dev-tool",
			behaviors:[
				lazyPageBehavior
			],
			observers:[
				"__getDoc(hash)"
			],
			__getDoc:function(hash){
				this.async(function(){
					var docs = this.activity();
					if(docs.doc.dev!=undefined){
						this.set("remarks",docs.doc.dev.remark);
						this.set("cases",docs.doc.dev.cases);
						this.set("ele",docs.ele);
					}else{
						this.set("remarks",[]);
						this.set("cases",[]);
						this.set("ele",null);
					}
					
				});
			},
			callTest:function(e){
				var model = e.model;
				this.ele[model.item.test].apply(this.ele,model.item.properties);
			}
		})
	</script>
</dom-module>
