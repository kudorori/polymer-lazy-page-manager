<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../neon-animation/neon-animatable-behavior.html"/>
<link rel="import" href="../neon-animation/neon-animation-behavior.html"/>
<link rel="import" href="../neon-animation/neon-animations.html"/>
<link rel="import" href="lazy-page-redux-behaviors.html"/>
<script>
	var __lazyPageDocs=null;
	var __lazyPageModule={};
	lazyPageBehavior=[Polymer.IronResizableBehavior,lazyPageReduxBehavior,{
		properties:{
			dataPage:{
				type:String
			},
			/*
				存放網址參數 ex: /:foo/:boo => {foo:[val],boo:[val]}
			*/
			params:{
				type:Object,
				notify:true
			},
			/*
				存放定義檔參數
			*/
			prop:{
				type:Object,
				notify:true
			},
			active:{
				type:Boolean,
				observer:"__activeChanged"
			},
			config:{
				type:Object,
				statePath:"config"
			},
			sitemap:{
				type:Object,
				statePath:"doc.sitemap"
			},
			shared:{
				type:Object,
				statePath:"shared"
			}
		},
		actions:{
			shared:function(key,value){
				return {
					type:"SET_SHARED",
					key:key,
					value:value
				}
			}
		},
		__activeChanged:function(b){
			if(!this.isUndefined(b,this.activeReady)){
				this.async(function(){
					this.activeReady();
				});
			}
		},
		isUndefined:function(){
			for(var key in arguments){
				var item = arguments[key];
				if(typeof(item)=="array"){
					if(
						item.indexOf(null)!=-1||
						item.indexOf(undefined)!=-1||
						item.indexOf(false)!=-1||
						item.indexOf("")!=-1
					){
						return true;
					}
				}else{
					if([null,undefined,false].indexOf(item)!=-1){
						return true;
					}
				}
			}
			return false;
		},
		/*
			依照目前路徑取得頁面doc檔
			return [
				{},
				{}
			]
		*/
		paths:function(){
			var hash = location.hash;
			
			var get_doc = function(items,prefix){
				var result = [];
				for(var key in items.reverse()){
					var item = items[key];
					var pattern = item.pattern+(item.suffix!=undefined?item.suffix:"");
					var regex_str = this.__pattern2regex(pattern);
					var isCheck = new RegExp(regex_str).test(hash);
					if(isCheck){
						result.push(item);
						if(item.pages!=undefined){
							result = result.concat(get_doc(item.pages,pattern));
						}
						return result;
					}
				}
				return result;
			}.bind(this);
			
			return get_doc(__lazyPageDocs.sitemap,"");
		},
		/*
			取得目前正在執行doc&element
			return
				{
					doc:{object},
					ele:{element}
				}
		*/
		activity:function(){
			var paths = this.paths();
			var dataPage = paths.map(function(item){
				return item.pattern;
			}).join("");
			return {
				doc:paths.pop(),
				ele:__lazyPageModule[dataPage]
			};
		},
		__pattern2regex:function(pattern){
			var regex = new RegExp(/(:[\w]*)/g);
			return pattern.replace(regex,"([\\w]*)");
		},
		__confirm:function(){
			return new Promise(function(resolve,reject){
				resolve();
			});
		}
	}]
	
	lazyDialogBehavior=[Polymer.IronOverlayBehavior,lazyPageBehavior,{
		properties:{
			
		},
		observers:[
			"_lazyOpenedChanged(opened)"
		],
		listeners:{
			"iron-overlay-canceled":"__clickBackup"
		},
		__clickBackup:function(e){
			e.stopPropagation();
			e.preventDefault();
			history.back();
		},
		_lazyOpenedChanged:function(opened){
			this.active=opened;
		}
	}];
	
	lazyAnimationBehavior=[
		Polymer.NeonAnimatableBehavior,
		{
			properties:{
				animationConfig: {
			        type: Object,
			        value: function() {
			          	return {
				            'entry': {
				             	name: 'fade-in-animation',
				             	node:this,
				             	timing:500
				            },
				            'exit': {
				              	name: 'fade-out-animation',
				             	node:this,
				             	timing:500
				            }
						};
			        }
			    },
			}
		}
	];
	
	lazyAnimationPageBehavior=[
		lazyPageBehavior,lazyAnimationBehavior
	];
	lazyAnimationDialogBehavior=[
		lazyDialogBehavior,lazyAnimationBehavior
	];
</script>
